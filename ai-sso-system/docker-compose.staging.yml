version: '3.9'
services:
  staging-db:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: ai_sso_staging
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - staging_db_data:/var/lib/postgresql/data

  staging-redis:
    image: redis:7-alpine

  backend-staging:
    build: ./backend
    restart: unless-stopped
    env_file: environments/staging.env
    depends_on: [staging-db, staging-redis]

  frontend-staging:
    build: ./frontend
    environment:
      - VITE_API_URL=https://staging-accounts.digikenya.co.ke

  nginx-staging:
    build: ./nginx
    ports: ["8080:80", "8443:443"]
    volumes:
      - ./frontend/dist:/usr/share/nginx/html:ro
      - ./certbot/staging:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    depends_on: [backend-staging, frontend-staging]

volumes:
  staging_db_data: